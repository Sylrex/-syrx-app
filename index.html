<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYRX Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1e3a8a, #10b981);
            color: #fff;
            text-align: center;
            min-height: 100vh;
        }
        .page {
            display: none;
        }
        .active {
            display: block;
        }
        .logo {
            width: 100px;
            margin-bottom: 20px;
        }
        .user-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid #fff;
            margin-bottom: 15px;
        }
        .task-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
            margin: 0 auto;
        }
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }
        button:hover {
            transform: scale(1.05);
        }
        .task-btn {
            background-color: #3b82f6;
            color: #fff;
        }
        .task-btn:hover {
            background-color: #2563eb;
        }
        .daily-btn {
            background-color: #10b981;
            color: #fff;
        }
        .daily-btn:hover {
            background-color: #059669;
        }
        .wallet-btn {
            background-color: #f97316;
            color: #fff;
        }
        .wallet-btn:hover {
            background-color: #ea580c;
        }
        .nav-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 10px;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2);
        }
        .nav-buttons button {
            background-color: #6b7280;
            color: #fff;
        }
        .nav-buttons button:hover {
            background-color: #4b5563;
        }
        .leaderboard {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px auto;
            max-width: 300px;
        }
        .leaderboard-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            color: #fff;
        }
        .referral-section {
            margin: 20px 0;
        }
        .referral-section button {
            background-color: #8b5cf6;
        }
        .referral-section button:hover {
            background-color: #7c3aed;
        }
    </style>
</head>
<body>
    <div id="home" class="page active">
        <img src="/public/icon.png" class="logo" alt="SYRX Logo">
        <img id="user-photo" class="user-photo" src="" alt="User Photo">
        <h2 id="user-name">Welcome!</h2>
        <p>User ID: <span id="user-id">Loading...</span></p>
        <p>Your Points: <span id="points">0</span></p>
    </div>

    <div id="tasks" class="page">
        <h2>Tasks</h2>
        <div class="task-buttons">
            <button class="task-btn" onclick="completeTask('x')">Follow X Account</button>
            <button class="task-btn" onclick="completeTask('facebook')">Follow Facebook</button>
            <button class="task-btn" onclick="completeTask('youtube1')">Follow YouTube 1</button>
            <button class="task-btn" onclick="completeTask('youtube2')">Follow YouTube 2</button>
            <button class="daily-btn" id="daily-login">Daily Login (+10 points)</button>
            <button class="wallet-btn" id="connect-wallet">Connect TON Wallet</button>
        </div>
        <p>Wallet Status: <span id="wallet-status">Not Connected</span></p>
    </div>

    <div id="referrals" class="page">
        <h2>Referrals</h2>
        <div class="referral-section">
            <p>Your Referral Link: <span id="ref-link">Generating...</span></p>
            <button onclick="shareRefLink()">Share Referral Link</button>
        </div>
        <h3>Top 100 Leaderboard</h3>
        <div class="leaderboard" id="leaderboard"></div>
    </div>

    <div class="nav-buttons">
        <button onclick="showPage('home')">Home</button>
        <button onclick="showPage('tasks')">Tasks</button>
        <button onclick="showPage('referrals')">Referrals</button>
    </div>

    <script>
        const WebApp = window.Telegram.WebApp;
        WebApp.ready();

        const user = WebApp.initDataUnsafe.user;
        let userId = user ? user.id : 'guest';
        if (user) {
            document.getElementById('user-name').innerText = `Welcome, ${user.first_name || 'User'}!`;
            document.getElementById('user-id').innerText = userId;
            if (user.photo_url) {
                document.getElementById('user-photo').src = user.photo_url;
            }
        }

        // Fetch points
        async function fetchPoints() {
            try {
                const response = await fetch(`https://syrx.onrender.com/api/points/${userId}`);
                const data = await response.json();
                document.getElementById('points').innerText = data.points || 0;
            } catch (error) {
                console.error('Error fetching points:', error);
            }
        }
        fetchPoints();

        // Daily Login
        const dailyLoginBtn = document.getElementById('daily-login');
        async function checkDailyLogin() {
            try {
                const response = await fetch(`https://syrx.onrender.com/api/daily-login/${userId}`);
                const data = await response.json();
                if (!data.can_login) {
                    dailyLoginBtn.disabled = true;
                    dailyLoginBtn.innerText = 'Already Logged In Today';
                }
            } catch (error) {
                console.error('Error checking daily login:', error);
            }
        }
        checkDailyLogin();
        dailyLoginBtn.onclick = async () => {
            try {
                const response = await fetch(`https://syrx.onrender.com/api/daily-login/${userId}`, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    document.getElementById('points').innerText = data.points;
                    dailyLoginBtn.disabled = true;
                    dailyLoginBtn.innerText = 'Already Logged In Today';
                    WebApp.showAlert('+10 points added!');
                }
            } catch (error) {
                console.error('Error during daily login:', error);
                WebApp.showAlert('Error during login. Try again.');
            }
        };

        // Tasks
        const taskLinks = {
            x: 'https://x.com/SylrexOfficial?t=xMY6eEauM0DXY5VllXdT-w&s=09',
            facebook: 'https://www.facebook.com/share/1JYzm6CGsS/',
            youtube1: 'https://www.youtube.com/@SylrexOfficial',
            youtube2: 'https://www.youtube.com/@Sylrex_Official'
        };
        async function completeTask(task) {
            try {
                WebApp.openLink(taskLinks[task]);
                const response = await fetch(`https://syrx.onrender.com/api/task/${userId}/${task}`, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    document.getElementById('points').innerText = data.points;
                    WebApp.showAlert('Task completed! +5 points');
                }
            } catch (error) {
                console.error('Error completing task:', error);
            }
        }

        // TON Wallet Connection
        const tonConnectUI = new TONConnectUI.TonConnectUI({
            manifestUrl: 'https://syrx.onrender.com/tonconnect-manifest.json',
            buttonRootId: 'connect-wallet'
        });
        tonConnectUI.onStatusChange(walletInfo => {
            const walletStatus = document.getElementById('wallet-status');
            const connectBtn = document.getElementById('connect-wallet');
            if (walletInfo) {
                walletStatus.innerText = `Connected: ${walletInfo.account.address.slice(0, 6)}...${walletInfo.account.address.slice(-4)}`;
                connectBtn.innerText = 'Disconnect Wallet';
                fetch(`https://syrx.onrender.com/api/wallet/${userId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wallet_address: walletInfo.account.address })
                }).then(() => fetchPoints());
            } else {
                walletStatus.innerText = 'Not Connected';
                connectBtn.innerText = 'Connect TON Wallet';
            }
        });

        // Referral System
        const refLinkElem = document.getElementById('ref-link');
        const botUsername = 'SYRXApp_bot';
        const refLink = `https://t.me/${botUsername}?start=ref_${userId}`;
        refLinkElem.innerText = refLink;
        async function shareRefLink() {
            try {
                WebApp.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(refLink)}&text=Join SYRX and earn points!`);
                await fetch(`https://syrx.onrender.com/api/referral/${userId}`, { method: 'POST' });
                fetchPoints();
            } catch (error) {
                console.error('Error sharing referral:', error);
            }
        }

        // Leaderboard
        async function fetchLeaderboard() {
            try {
                const response = await fetch('https://syrx.onrender.com/api/leaderboard');
                const data = await response.json();
                const leaderboard = document.getElementById('leaderboard');
                leaderboard.innerHTML = '';
                data.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'leaderboard-item';
                    div.innerText = `#${index + 1} User${item.user_id} - ${item.points} points`;
                    leaderboard.appendChild(div);
                });
            } catch (error) {
                console.error('Error fetching leaderboard:', error);
            }
        }
        fetchLeaderboard();

        // Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }
    </script>
</body>
    </html>
