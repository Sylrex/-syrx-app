<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SYRX Mini App</title>
<style>
body{margin:0;font-family:sans-serif;background:#0b1020;color:#fff;display:flex;justify-content:center;}
.app{max-width:700px;width:100%;padding:20px;}
.card{background:#121832;border-radius:18px;padding:20px;margin-bottom:16px;text-align:center;}
.logo-inner{font-size:28px;font-weight:800;color:#8fb6ff;}
img{border-radius:50%;}
.btn{padding:12px 20px;border:none;border-radius:14px;cursor:pointer;margin:8px 0;background:#2b47c8;color:#fff;font-weight:600;}
.tab{cursor:pointer;padding:12px;background:#0d1430;margin:0 4px;border-radius:12px;display:inline-block;}
.tab.active{background:linear-gradient(180deg,#1a2b6a,#0e163a);}
.hidden{display:none;}
.grid{display:grid;gap:12px;}
</style>
</head>
<body>
<div class="app">
  <!-- Navigation Tabs -->
  <div class="grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:12px;">
    <div class="tab active" data-tab="home">ğŸ  Home</div>
    <div class="tab" data-tab="tasks">âœ… Tasks</div>
    <div class="tab" data-tab="leaderboard">ğŸ† Leaderboard</div>
  </div>

  <!-- Home Page -->
  <section id="home" class="page">
    <div class="card">
      <div class="logo-inner">SYRX</div>
      <h2>Welcome, <span id="playerName">Guest</span>!</h2>
      <img id="playerAvatar" src="default-avatar.png" style="width:100px;height:100px;">
      <p>Your Points: <span id="playerPoints">0</span></p>
      <p>Your Referral Code: <span id="playerReferral">â€”</span></p>
      <button class="btn" id="claimBtn">ğŸ’ Claim Reward</button>
    </div>
  </section>

  <!-- Tasks Page -->
  <section id="tasks" class="page hidden">
    <div class="card">
      <h3>Daily Tasks</h3>
      <div id="taskList"></div>
    </div>
  </section>

  <!-- Leaderboard Page -->
  <section id="leaderboard" class="page hidden">
    <div class="card">
      <h3>Leaderboard</h3>
      <div id="leaderList"></div>
    </div>
  </section>
</div>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
const tg = window.Telegram?.WebApp;
tg?.ready();

let telegramId = null;
let playerName = 'Guest';
let playerAvatar = 'default-avatar.png';
let playerUsername = '';

if(tg?.initDataUnsafe?.user){
  const user = tg.initDataUnsafe.user;
  telegramId = user.id;
  playerName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
  playerUsername = user.username || '';
  if(user.photo_url) playerAvatar = user.photo_url;
}

document.getElementById('playerName').textContent = playerName;
document.getElementById('playerAvatar').src = playerAvatar;

// Navigation Tabs
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
    document.getElementById(tab.dataset.tab).classList.remove('hidden');
  });
});

// API Helpers
async function fetchUserData(){
  if(!telegramId) return;
  const res = await fetch(`/api/user/${telegramId}`);
  const data = await res.json();
  document.getElementById('playerPoints').textContent = data.points;
  document.getElementById('playerReferral').textContent = data.referral_code;
  renderTasks(data.tasks);
  renderLeaderboard(data.leaderboard);
}

async function claimReward(){
  if(!telegramId) return;
  const res = await fetch('/api/claim', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ telegram_id: telegramId })
  });
  const data = await res.json();
  alert(data.message);
  fetchUserData();
}

// Tasks Rendering
function renderTasks(tasks){
  const container = document.getElementById('taskList');
  container.innerHTML = '';
  tasks.forEach(task=>{
    const btn = document.createElement('button');
    btn.textContent = task.completed ? 'âœ… Completed' : 'Open';
    btn.className = 'btn';
    btn.addEventListener('click',()=>window.open(task.url,'_blank'));
    container.appendChild(document.createTextNode(task.title + ' '));
    container.appendChild(btn);
    container.appendChild(document.createElement('br'));
  });
}

// Leaderboard Rendering
function renderLeaderboard(leaderboard){
  const container = document.getElementById('leaderList');
  container.innerHTML = '';
  leaderboard.forEach(player=>{
    const div = document.createElement('div');
    div.style.display='flex';
    div.style.alignItems='center';
    div.style.gap='12px';
    div.innerHTML = `<img src="${player.photo_url||'default-avatar.png'}" width="50" height="50" style="border-radius:50%;"> 
                     <b>${player.first_name} ${player.last_name}</b> - ${player.points} pts`;
    container.appendChild(div);
  });
}

// Button Events
document.getElementById('claimBtn').addEventListener('click', claimReward);

// Initial Fetch
fetchUserData();
</script>
</body>
  </html>
